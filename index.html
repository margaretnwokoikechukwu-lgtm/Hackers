<script>

/* ==========================================================
   MATRIX BACKGROUND
========================================================== */

let canvas = document.getElementById("matrixCanvas");
let ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let letters = "01".split("");
let fontSize = 14;
let columns = canvas.width / fontSize;
let drops = [];

for (let x = 0; x < columns; x++) drops[x] = 1;

function drawMatrix() {
    ctx.fillStyle = "rgba(0,0,0,0.05)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "#00f5d4";
    ctx.font = fontSize + "px monospace";

    for (let i = 0; i < drops.length; i++) {
        let text = letters[Math.floor(Math.random() * letters.length)];
        ctx.fillText(text, i * fontSize, drops[i] * fontSize);

        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975)
            drops[i] = 0;

        drops[i]++;
    }
}
setInterval(drawMatrix, 33);


/* ==========================================================
   GAME VARIABLES
========================================================== */

let playerSecret = "";
let computerSecret = "";
let difficulty = "";

let round = 1;
let playerScore = 0;
let computerScore = 0;

let computerGuess = "";
let candidates = [];
let usedGuesses = [];

let gameActive = false;
let playerTurnActive = true;


/* ==========================================================
   START GAME
========================================================== */

function startGame() {

    playerSecret = document.getElementById("playerSecret").value;
    difficulty = document.getElementById("difficulty").value;

    if (!validCode(playerSecret)) {
        alert("Invalid Secret Code (4 UNIQUE digits required)");
        return;
    }

    generateCandidates();
    computerSecret = generateCode();

    round = 1;
    playerScore = 0;
    computerScore = 0;
    usedGuesses = [];

    document.getElementById("setupPanel").classList.add("hidden");
    document.getElementById("gamePanel").classList.remove("hidden");

    log("=== BATTLE STARTED ===");
    log("Difficulty: " + difficulty.toUpperCase());

    gameActive = true;
    playerTurnActive = true;

    showTutorial();
}


/* ==========================================================
   VALIDATION
========================================================== */

function validCode(code) {
    return code.length === 4 &&
        new Set(code).size === 4 &&
        /^\d+$/.test(code);
}


/* ==========================================================
   RANDOM CODE
========================================================== */

function generateCode() {
    let digits = "0123456789";
    let result = "";

    while (result.length < 4) {
        let r = digits[Math.floor(Math.random() * 10)];
        if (!result.includes(r)) result += r;
    }
    return result;
}


/* ==========================================================
   CALCULATE RESULT
========================================================== */

function calculateResult(secret, guess) {
    let dead = 0;
    let injured = 0;

    for (let i = 0; i < 4; i++) {
        if (guess[i] === secret[i]) dead++;
        else if (secret.includes(guess[i])) injured++;
    }
    return { dead, injured };
}


/* ==========================================================
   PLAYER TURN
========================================================== */

function playerTurn() {

    if (!gameActive || !playerTurnActive) return;

    document.getElementById("clickSound").play();

    let guess = document.getElementById("playerGuess").value;

    if (!validCode(guess)) {
        alert("Invalid Guess");
        return;
    }

    let result = calculateResult(computerSecret, guess);

    log("YOU → " + guess + " | " + result.dead + "D " + result.injured + "I");

    if (result.dead === 4) {
        playerScore++;
        updateStats();
        endRound("YOU WIN THIS ROUND!");
        return;
    }

    playerTurnActive = false;
    document.getElementById("turnIndicator").innerText = "AI";

    setTimeout(computerPlay, 800);

    document.getElementById("playerGuess").value = "";
}


/* ==========================================================
   COMPUTER PLAY
========================================================== */

function computerPlay() {

    if (!gameActive) return;

    if (difficulty === "easy") {
        do {
            computerGuess = generateCode();
        } while (usedGuesses.includes(computerGuess));
    }

    else if (difficulty === "normal") {
        computerGuess = candidates[Math.floor(Math.random() * candidates.length)];
    }

    else {
        computerGuess = findBestGuess();
        log("AI analyzing " + candidates.length + " possibilities...");
    }

    usedGuesses.push(computerGuess);

    document.getElementById("computerGuessDisplay").innerText =
        "Computer attacks: " + computerGuess;
}


/* ==========================================================
   COMPUTER RESULT
========================================================== */

function computerTurn(){

    if (!gameActive || playerTurnActive) return;

    document.getElementById("clickSound").play();

    let dead = parseInt(document.getElementById("deadInput").value);
    let injured = parseInt(document.getElementById("injuredInput").value);

    if (isNaN(dead) || isNaN(injured) || dead + injured > 4) {
        alert("Invalid result numbers");
        return;
    }

    log("CPU → " + computerGuess + " | " + dead + "D " + injured + "I");

    if (dead === 4) {
        computerScore++;
        updateStats();
        endRound("COMPUTER WINS THIS ROUND!");
        return;
    }

    filterCandidates(computerGuess, dead, injured);

    round++;
    updateStats();

    playerTurnActive = true;
    document.getElementById("turnIndicator").innerText = "YOU";

    document.getElementById("deadInput").value = "";
    document.getElementById("injuredInput").value = "";
}


/* ==========================================================
   AI SYSTEM
========================================================== */

function generateCandidates() {
    candidates = [];
    for (let i = 0; i < 10000; i++) {
        let code = i.toString().padStart(4, "0");
        if (validCode(code)) candidates.push(code);
    }
}

function filterCandidates(guess, dead, injured) {
    candidates = candidates.filter(code => {
        let result = calculateResult(code, guess);
        return result.dead === dead && result.injured === injured;
    });
    log("Remaining possibilities: " + candidates.length);
}

function findBestGuess(){
    let bestGuess = candidates[0];
    let bestScore = Infinity;

    for(let guess of candidates.slice(0,40)){
        let scoreMap = {};

        for(let possible of candidates){
            let result = calculateResult(possible, guess);
            let key = result.dead+"-"+result.injured;
            if(!scoreMap[key]) scoreMap[key]=0;
            scoreMap[key]++;
        }

        let worstCase = Math.max(...Object.values(scoreMap));
        if(worstCase < bestScore){
            bestScore = worstCase;
            bestGuess = guess;
        }
    }
    return bestGuess;
}


/* ==========================================================
   END ROUND
========================================================== */

function endRound(message){

    gameActive = false;
    log("=== " + message + " ===");

    document.getElementById("winText").innerText = message;
    document.getElementById("winOverlay").classList.remove("hidden");

    document.getElementById("winSound").play();
}


/* ==========================================================
   RESET
========================================================== */

function resetRound() {
    round = 1;
    usedGuesses = [];
    generateCandidates();
    computerSecret = generateCode();
    updateStats();
    log("=== NEW ROUND STARTED ===");
    gameActive = true;
    playerTurnActive = true;
}

function resetGame() {
    location.reload();
}


/* ==========================================================
   UI
========================================================== */

function updateStats() {
    document.getElementById("round").innerText = round;
    document.getElementById("playerScore").innerText = playerScore;
    document.getElementById("computerScore").innerText = computerScore;
}

function log(text) {
    let logDiv = document.getElementById("log");
    logDiv.innerHTML += text + "<br>";
    logDiv.scrollTop = logDiv.scrollHeight;
}

function closeOverlay(){
    document.getElementById("winOverlay").classList.add("hidden");
    resetRound();
}


/* ==========================================================
   TUTORIAL SYSTEM
========================================================== */

function showTutorial(){
    setTimeout(()=>{
        alert(
`HOW TO PLAY:

1. Enter a 4-digit secret (no repeated numbers).
2. Dead = correct number in correct position.
3. Injured = correct number wrong position.
4. First to get 4 Dead wins.
5. Hard mode uses smart AI logic.

Good luck Hacker.`
        );
    },1000);
}

</script>